```yml
title: Now 2 にアップグレードした
description: ホームページを Now 2 にアップグレードした
image: /asset/image/og.png
```

# Now 2 にアップグレードした

このページは [Now](https://zeit.co/now) でホスティングしているが、つい 11 月 9 日に [Now 2.0](https://zeit.co/blog/now-2) がリリースされた。このサイトは [6 日前に対応](https://github.com/aggre/aggre.io/commit/5eadd67a65f924c8d5a5f2dc23c5815474303b43) していたのだが、引っ越しなどが続きなかなか記事にできなかった。

さて、[もろもろの変更点は公式を見ていただくのが一番分かりやすい](https://zeit.co/blog/now-2) として、実際に試した所感を超簡単に書く。

## ローカルのまま動く環境、ではなくなった

今までは、Node.js 環境のアプリケーションであれば基本的にローカルと同じように動作するサーバとして Now を使うことができた。

これは Now が `"start": "serve"` のような npm script を実行してくれる、という規約があったからだ。

Now 2.0 では npm script を実行しなくなった。代わりに `builds` というプロパティに指定したビルドプロセスを実行する。

このページは [serve](https://github.com/zeit/serve) が走ることでホスティングされていたが、Now 2.0 になってからはこれに頼ることができなくなった。

現時点での `now.json` はこうなっている。

```json
{
	"version": 2,
	"alias": "aggre.io",
	"builds": [{ "src": "dist/**", "use": "@now/static" }],
	"routes": [{ "src": "/(.*)", "dest": "/dist/$1" }]
}
```

このページは静的ファイルをエントリーポイントにした SPA なので、`dist/**` を `@now/static` というビルトインのビルダーでビルドしている。ここでいうビルドとは、Now のバックエンドとなる Now Lambdas へのデプロイ処理だ。Now Lambdas の実体はコンテナと思われる。

`routes` プロパティではすべてのリクエストを `dist` に転送している。

設定ファイルが複雑になったように見えるが、実際には Now の規約が薄くなり、開発者の裁量が増えたと考えるのが正しそうだ。

残念なのは、ローカルのまま動く環境ではなくなったという点だ。Node.js サーバを実行するために `"builds": [{ "src": "index.js", "use": "@now/node-server" }]` という指定が可能だとあるが、まず僕の環境ではデプロイに失敗したし、そもそも非推奨になりそうな気配がある。

今後 Now のローカル環境などが用意されるのかもしれない。

## CDN がフリープランでも使える

今回のアップデートで実は一番うれしいのがこれ。今まで、CDN は \$5/月 の課金( プライシングが更新されているのでうろ覚え )が必要だった。

実際に試すと、レスポンスヘッダに `x-now-cache` と `x-now-trace` が追加されているのが分かる。

ただ、常に `x-now-cache: MISS` が返ってきているように見えるので、実際に CDN が有効なのかどうかは分からなかった。[静的ファイルは常に全リージョンに配置される](https://zeit.co/docs/v2/deployments/concepts/cdn-and-global-distribution#basic-cdn) と書いてあるので、キャッシュと捉えるか実体と捉えるのかの差か? など疑問はある。

---

今回のアップデートは _ロックインのないサーバーレス環境_ としての Now のミッションが大きく前進したと思う。

静的サイトに限らず、サーバーレスのコンピューティング環境としてさらに有効に使っていけるのではと思った。

おしまい。
